<!doctype html>
<html lang="en">
  <head>
  <title>
    WSL Dev Environment Setup
    -
    ZM
  </title>
  <meta charset="utf-8">
  <meta http-equiv="content-language" content="en">
  <meta name="theme-color" content="#ffffff">
  <meta name="supported-color-schemes" content="light dark">
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="applicable-device" content="pc,mobile">
  <meta name="author" content="ZM">
  <meta name="darkreader-lock">
    <meta name="description" content="WSL Dev Environment Setup">
    <meta
      name="keywords"
      content="ZM,WSL,Devcontainer"
    >
  <link rel="icon" href="/static/img/favicon.ico">
  <link rel="apple-touch-icon" href="/static/img/logo.png">
  <link rel="stylesheet" href="/static/css/common.css?t=20230806215152">
  <link rel="stylesheet" href="/static/css/theme-dark.css?t=20230806215152">
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap"
    rel="stylesheet"
  >

  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">


    
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.21.0/dist/tocbot.min.css">




    <link rel="stylesheet" href="/static/css/post.css?t=20230806215152">
    <link rel="stylesheet" href="/static/css/code-dark.css?t=20230806215152">
    <link rel="stylesheet" href="/static/css/code-light.css?t=20230806215152">

  <script>
    window.blog = {
      baseurl: '',
      buildAt: '20230806215152',
      darkMode: false,
      initDarkMode: function (flag) {
        if (flag && flag === 'true') this.darkMode = true;
        else if (flag && flag === 'false') this.darkMode = false;
        else this.darkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.className = this.darkMode ? 'dark' : '';
        document
          .querySelector('meta[name=theme-color]')
          .setAttribute('content', this.darkMode ? '#2D2E32' : '#FFFFFF');
      },
    };
    blog.initDarkMode(localStorage.darkMode);
  </script>
</head>
<body>
    <div class="row">
      <div class="col1">
        <header class="header">
  <a href="https://www.zhoumike.com/notes/2021/01/20/wsl2-configuration.html">
    <span class="logo">Z.M.</span>
  </a>
  <nav class="menu">
    

      
      

      
        <a href="/notes.html"  class="hover-underline is-active-page">
          
            Notes
          
        </a>
      
    

      
      

      
    

      
      

      
        <a href="/search.html"  class="hover-underline ">
          
            <span class="material-icons menu-icon">search</span>
          
        </a>
      
    </nav>
</header>
<div class="page page-post">
          
          <div class="pretitle">
            
            
            <a href="/notes.html">
              <code class="language-plaintext">Notes</code>
            </a>
            <a
                href="/notes.html?category=WSL"
                class="category-link hover-underline"
              >WSL</a><a
                href="/notes.html?category=Devcontainer"
                class="category-link hover-underline"
              >Devcontainer</a>
          </div>
          <h1 class="title" id="WSL Dev Environment Setup">WSL Dev Environment Setup</h1>
          <div class="subtitle">
            <span class="material-icons">calendar_month</span>
              <span>
                2021-01-20</span>
            
          </div>
          <div class="post"><h2 id="overview">Overview</h2>

<p>Setting up Windows Subsystem for Linux (WSL) is simple, but full-time development in WSL requires extra setup and workarounds. Let’s document some of these problem-solutions!</p>

<h2 id="run-gui-apps-in-wsl">Run GUI Apps in WSL</h2>

<p>Run graphical applications in WSL by setting up a display server on Windows host machine.</p>

<h3 id="setup-vcxsrv">Setup VcXSrv</h3>

<ol>
  <li>
<code class="language-plaintext highlighter-rouge">Windows</code> Install <a href="https://github.com/ArcticaProject/vcxsrv" rel="noreferrer" target="_blank">VcXSrv</a>
</li>
  <li>
<code class="language-plaintext highlighter-rouge">Windows</code> Allow VcXSrv in firewall rules</li>
  <li>
<code class="language-plaintext highlighter-rouge">WSL</code> Add to ~/.bashrc:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">DISPLAY</span><span class="o">=</span><span class="si">$(</span><span class="nb">cat</span> /etc/resolv.conf | <span class="nb">grep </span>nameserver | <span class="nb">awk</span> <span class="s1">'{print $2; exit;}'</span><span class="si">)</span>:0.0
<span class="nb">export </span><span class="nv">LIBGL_ALWAYS_INDIRECT</span><span class="o">=</span>1
<span class="c"># sudo /etc/init.d/dbus start &amp;&gt; /dev/nulll</span>
</code></pre></div></div>

<h3 id="vscode-devcontainer">VSCode Devcontainer</h3>

<p>We can even run GUI applications from VSCode Devcontainers. UI test suites in dev mode? Not a problem.</p>

<ol>
  <li>Add to project’s devcontainer.json:</li>
</ol>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"runArgs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="s2">"--network=host"</span><span class="w">
</span><span class="p">}</span><span class="err">,</span><span class="w">
</span><span class="nl">"containerEnv"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"DISPLAY"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${localEnv:DISPLAY}"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="machine-learning-in-wsl">Machine Learning in WSL</h2>

<p>Run machine learning, or any code that requires GPU drivers, inside WSL.</p>

<blockquote>
  <p>Taken directly from <a href="https://ocdevel.com/blog/20201207-wsl2-gpu-docker" rel="noreferrer" target="_blank">this site</a>.</p>
</blockquote>

<p>Full details for this post at <a href="https://docs.nvidia.com/cuda/wsl-user-guide" rel="noreferrer" target="_blank">docs.nvidia.com/cuda/wsl-user-guide</a>, this post expands links’ instructions and distills just the essential commands without context.</p>

<h3 id="install-nvidia-wsl2-compatible-driver">Install Nvidia WSL2-compatible driver</h3>

<ol>
  <li>
<a href="https://developer.nvidia.com/cuda/wsl" rel="noreferrer" target="_blank">Nvidia link</a> &gt; Get CUDA Driver &gt; download, install</li>
</ol>

<h3 id="install-docker--nvidia-stuff">Install Docker + Nvidia stuff</h3>

<ol>
  <li>Install Docker and Nvidia stuff</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ distribution</span><span class="o">=</span><span class="si">$(</span><span class="nb">.</span> /etc/os-release<span class="p">;</span><span class="nb">echo</span> <span class="nv">$ID$VERSION_ID</span><span class="si">)</span>
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-L</span> https://nvidia.github.io/nvidia-docker/gpgkey | <span class="nb">sudo </span>apt-key add -
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-L</span> https://nvidia.github.io/nvidia-docker/<span class="nv">$distribution</span>/nvidia-docker.list | <span class="nb">sudo tee</span> /etc/apt/sources.list.d/nvidia-docker.list
<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-L</span> https://nvidia.github.io/libnvidia-container/experimental/<span class="nv">$distribution</span>/libnvidia-container-experimental.list | <span class="nb">sudo tee</span> /etc/apt/sources.list.d/libnvidia-container-experimental.list
</code></pre></div></div>

<ol>
  <li>Restart Docker service</li>
</ol>

<h3 id="test">Test</h3>

<ol>
  <li><code class="language-plaintext highlighter-rouge">docker run --gpus all nvcr.io/nvidia/k8s/cuda-sample:nbody nbody -gpu -benchmark</code></li>
</ol>

<h2 id="autostart-ssh-agent-in-wsl">Autostart SSH Agent in WSL</h2>

<p>Add to ~/.bashrc:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Starts SSH-Agent, asks identity/key passwords per linux boot/startup</span>
<span class="nv">SSH_ENV</span><span class="o">=</span><span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/.ssh/agent-environment"</span>
<span class="k">function </span>start_agent <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">"Initialising new SSH agent..."</span>
  /usr/bin/ssh-agent | <span class="nb">sed</span> <span class="s1">'s/^echo/#echo/'</span> <span class="o">&gt;</span> <span class="s2">"</span><span class="k">${</span><span class="nv">SSH_ENV</span><span class="k">}</span><span class="s2">"</span>
  <span class="nb">echo </span>succeeded
  <span class="nb">chmod </span>600 <span class="s2">"</span><span class="k">${</span><span class="nv">SSH_ENV</span><span class="k">}</span><span class="s2">"</span>
  <span class="nb">.</span> <span class="s2">"</span><span class="k">${</span><span class="nv">SSH_ENV</span><span class="k">}</span><span class="s2">"</span> <span class="o">&gt;</span> /dev/null
  /usr/bin/ssh-add<span class="p">;</span>
<span class="o">}</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="k">${</span><span class="nv">SSH_ENV</span><span class="k">}</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nb">.</span> <span class="s2">"</span><span class="k">${</span><span class="nv">SSH_ENV</span><span class="k">}</span><span class="s2">"</span> <span class="o">&gt;</span> /dev/null
  <span class="c"># ps ${SSH_AGENT_PID} doesn't work under cywgin</span>
  ps <span class="nt">-ef</span> | <span class="nb">grep</span> <span class="k">${</span><span class="nv">SSH_AGENT_PID</span><span class="k">}</span> | <span class="nb">grep </span>ssh-agent<span class="nv">$ </span><span class="o">&gt;</span> /dev/null <span class="o">||</span> <span class="o">{</span>
      start_agent<span class="p">;</span>
  <span class="o">}</span>
<span class="k">else
  </span>start_agent<span class="p">;</span>
<span class="k">fi</span>
</code></pre></div></div>

<h2 id="forward-gpg-keys">Forward GPG Keys</h2>

<p><a href="https://code.visualstudio.com/docs/remote/containers#_sharing-gpg-keys" rel="noreferrer" target="_blank">Forward GPG keys from WSL to VSCode devcontainers</a>.</p>

<ol>
  <li>Install <a href="https://www.gpg4win.org" rel="noreferrer" target="_blank">Gpg4win</a> on Windows</li>
  <li>Install <a href="https://linux.die.net/man/1/socat" rel="noreferrer" target="_blank">socat</a> in WSL distro. <code class="language-plaintext highlighter-rouge">sudo apt install socat</code>
</li>
  <li>Install <code class="language-plaintext highlighter-rouge">gpg</code> in WSL distro. <code class="language-plaintext highlighter-rouge">sudo apt install gpg</code>
</li>
  <li>Register a <code class="language-plaintext highlighter-rouge">pinentry</code> GUI in WSL distro. <code class="language-plaintext highlighter-rouge">echo pinentry-program /mnt/c/Program\ Files\ \(x86\)/Gpg4win/bin/pinentry.exe &gt; ~/.gnupg/gpg-agent.conf</code>
</li>
  <li>Reload <code class="language-plaintext highlighter-rouge">gpg</code> agent in WSL. <code class="language-plaintext highlighter-rouge">gpg-connect-agent reloadagent /bye</code>
</li>
  <li>Add command to forward GPG TTY in bashrc file in WSL distro. <code class="language-plaintext highlighter-rouge">export GPG_TTY=$(tty)</code>
</li>
</ol>

<h2 id="beautiful-wsl-terminal">Beautiful WSL Terminal</h2>

<p>Zshell (zsh) and Cobalt2 Theme makes a Windows terminal and shell pretty, even inside devcontainers!</p>

<h3 id="install-zsh-and-omz">Install Zsh and OMZ</h3>

<ol>
  <li>Install Windows Terminal (Microsoft product)</li>
  <li>Install Zshell (<a href="https://github.com/ohmyzsh/ohmyzsh/wiki/Installing-ZSH" rel="noreferrer" target="_blank">https://github.com/ohmyzsh/ohmyzsh/wiki/Installing-ZSH</a>) - might need to restart windows terminal to see the default shell change</li>
  <li>Add to <code class="language-plaintext highlighter-rouge">~/.zshrc</code> to undo default LESS -R invocation. <code class="language-plaintext highlighter-rouge">unset LESS</code>
</li>
  <li>Install oh-my-zsh (<a href="https://github.com/ohmyzsh/ohmyzsh" rel="noreferrer" target="_blank">https://github.com/ohmyzsh/ohmyzsh</a>) - use the simple wget install bash script</li>
</ol>

<h3 id="setup-cobalt2-theme">Setup Cobalt2 Theme</h3>

<ol>
  <li>Download colablt2.zsh-theme into your oh-my-zsh theme directory in your linux distro from <a href="https://github.com/wesbos/Cobalt2-iterm" rel="noreferrer" target="_blank">https://github.com/wesbos/Cobalt2-iterm</a> and set theme as your default (change var to ZSH_THEME=”cobalt2” in file ~/.zshrc)</li>
  <li>Download font and install on windows “Inconsolata for Powerline.otf” from <a href="https://github.com/powerline/fonts/tree/master/Inconsolata" rel="noreferrer" target="_blank">https://github.com/powerline/fonts/tree/master/Inconsolata</a>
</li>
  <li>Setup Windows Terminal cobalt2 theme with instructions from <a href="https://github.com/Reidond/cobalt2-windows-terminal" rel="noreferrer" target="_blank">https://github.com/Reidond/cobalt2-windows-terminal</a>
</li>
  <li>Restart Windows Terminal and god damn it looks good</li>
</ol>

<h3 id="zsh-in-devcontainer">Zsh in Devcontainer</h3>

<p>VSCode devcontainers can be beautiful too.</p>

<p>Put in Dockerfile:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>USER vscode
RUN <span class="se">\</span>
  <span class="c"># zsh cobalt2 theme</span>
  wget https://raw.githubusercontent.com/wesbos/Cobalt2-iterm/master/cobalt2.zsh-theme <span class="nt">-P</span> ~/.oh-my-zsh/themes/ <span class="se">\</span>
  <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="nt">-e</span> <span class="s1">'s/ZSH_THEME="codespaces"/ZSH_THEME="cobalt2"/g'</span> ~/.zshrc <span class="se">\</span>
  <span class="c"># unset zsh's default LESS -R</span>
  <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"</span><span class="se">\n\n</span><span class="s2">unset LESS</span><span class="se">\n</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> ~/.zshrc <span class="se">\</span>
  <span class="c"># zsh auto suggestions plugin</span>
  <span class="o">&amp;&amp;</span> git clone https://github.com/zsh-users/zsh-autosuggestions ~/.oh-my-zsh/custom/plugins/zsh-autosuggestions <span class="se">\</span>
  <span class="o">&amp;&amp;</span> <span class="nb">sed</span> <span class="nt">-i</span> <span class="nt">-e</span> <span class="s1">'s/plugins=(git)/plugins=(git zsh-autosuggestions)/g'</span> ~/.zshrc
USER root
</code></pre></div></div>

<p>Put in devcontainer.json:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"settings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"terminal.integrated.defaultProfile.linux"</span><span class="p">:</span><span class="w"> </span><span class="s2">"zsh"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"terminal.integrated.profiles.linux"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"zsh"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/bin/zsh"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">Might</span><span class="w"> </span><span class="err">need</span><span class="w"> </span><span class="err">some</span><span class="w"> </span><span class="err">tinkering</span><span class="w"> </span><span class="err">on</span><span class="w"> </span><span class="err">Windows</span><span class="p">,</span><span class="w"> </span><span class="err">not</span><span class="w"> </span><span class="err">necessary</span><span class="w"> </span><span class="err">on</span><span class="w"> </span><span class="err">Macs</span><span class="w">
    </span><span class="nl">"terminal.integrated.fontSize"</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w">
    </span><span class="nl">"terminal.integrated.fontFamily"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Inconsolata for Powerline"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="revisions">Revisions</h2>

<ul>
  <li>2022-02-12: Add Zsh sections</li>
  <li>2022-01-26: Add gpg and ssh keys forwarding</li>
  <li>2021-11-12: Initial commit</li>
</ul>
</div>
          
        </div>
        <footer class="footer">
  <span></span>
  <!--
    <a href="/static/xml/rss.xml">RSS订阅</a>
    <span>Theme By</span>
    <a href="https://github.com/TMaize/tmaize-blog">TMaize</a>
  -->
  <div class="footer-btn theme-toggler hide">
    <span class="material-icons">light_mode</span>
  </div>
  <div class="footer-btn to-top">
    <span class="material-icons">vertical_align_top</span>
  </div>
</footer>
</div>
      <div class="sidebar col2">
        <div class="toc-wrapper">
          <div class="toc-header">Contents</div>
          <nav id="toc"></nav>
        </div>
      </div>
    </div>
    <script type="text/javascript" src="/static/js/blog.js?t=20230806215152"></script>
<script type="text/javascript" src="/static/js/search.js?t=20230806215152"></script>

<script type="text/javascript">
    function toggleDrawIoFullScreen(divId) {
      const container = document.querySelector(`#${divId}`);
      if (container.classList.contains('drawio-full-screen')) {
        container.classList.remove('drawio-full-screen');
      } else {
        container.classList.add('drawio-full-screen');
      }
    }
  </script>

  


  <script
    type="text/javascript"
    src="https://cdn.jsdelivr.net/npm/tocbot@4.21.0/dist/tocbot.min.js"
  ></script>
  <script type="text/javascript">
    (function () {
      // see: https://github.com/tscanlin/tocbot#usage
      tocbot.init({
        tocSelector: '#toc',
        contentSelector: '.post',
        // ignoreSelector: "[data-toc-skip]",
        headingSelector: 'h2',
        orderedList: false,
        scrollSmooth: false,
      });
    })();
  </script>



</body>
</html>
